<main class="flex flex-col ml-48 self-center mb-16 mt-16 w-full max-w-[1256px] max-md:mt-10 max-md:max-w-full">
    <header class="flex gap-3.5 self-start">
        <img
            src="https://api.builder.io/api/v1/image/assets/TEMP/07073f8526333ac3749a4d99615ea0579a831ebe?placeholderIfAbsent=true&apiKey=ac04cd396e1f47f18955cd19640f183d"
            alt="GRI Social icon"
            class="object-contain shrink-0 my-auto rounded-full aspect-[1.04] w-[58px]"
        />
        <div class="flex flex-col">
            <h2 class="text-4xl font-semibold text-black">GRI Social</h2>
            <p class="self-center text-xl font-medium leading-none text-center text-gray-500">Social Performance</p>
        </div>
    </header>

    <section class="flex flex-col items-start py-14 px-16 mt-10 w-full bg-white rounded-2xl shadow-2xl max-w-[981px] max-md:px-5 max-md:mt-10">
        <h3 class="text-3xl font-semibold text-teal-700">Data Penyakit Akibat Kerja (GRI 403-10)</h3>
        <p class="mt-3 text-gray-500">Isi data penyakit akibat kerja untuk periode pelaporan ini.</p>

        <div class="w-full mt-8">
            <label for="od_report" class="block pb-2 text-base font-medium">Apakah ada penyakit akibat kerja yang dilaporkan?</label>
            <select id="od_report" name="od_report" class="w-full px-8 py-4 mt-2 text-base text-black rounded-2xl border border-gray-300 bg-slate-50 outline-none hover:ring focus:ring-2 focus:ring-teal-600 transition">
                <option value="ya">Ya</option>
                <option value="tidak" selected>Tidak</option> </select>
        </div>

        <div id="od_details" class="w-full mt-6 hidden">
            <div id="od_list" class="space-y-8"></div>

            <div class="mt-6 flex justify-end">
                <button type="button" id="od_add_item" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-teal-700 text-sm font-medium transition hover:bg-teal-50">
                    <svg xmlns="http://www.w.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Tambah Entri Penyakit
                </button>
            </div>
        </div>

        <div class="flex justify-end gap-4 mt-10 w-full">
            <button type="button" onclick="window.history.back()" class="px-8 py-2 text-base font-medium text-center text-teal-700 border-teal-700 border border-solid whitespace-nowrap bg-white rounded-xl hover:bg-teal-700 hover:text-white transition-colors">
                Sebelumnya
            </button>
            <a href="/umkm/social-4" class="px-8 py-2 text-base font-medium text-center text-white whitespace-nowrap bg-lime-500 rounded-xl hover:bg-lime-600 transition-colors">
                Simpan
            </a>
        </div>
    </section>
</main>

<template id="od_item_tpl">
    <div class="od-item border border-gray-200 rounded-2xl p-4">
        <div class="w-full">
            <label class="block pb-2 text-base font-medium">Jumlah kasus penyakit akibat kerja</label>
            <input type="number" min="0" value="1" class="od-cases w-full px-8 py-4 mt-2 text-base text-black rounded-2xl border border-gray-300 bg-slate-50 outline-none hover:ring focus:ring-2 focus:ring-teal-600 transition">
        </div>

        <div class="flex gap-5 mt-6 max-md:flex-col">
          <!-- Jenis penyakit -->
          <div class="w-6/12 max-md:w-full">
            <label class="block pb-2 text-base font-medium">Jenis penyakit yang teridentifikasi</label>
            <select name="od[0][disease]" class="od-disease w-full px-8 py-4 mt-2 text-base text-black rounded-2xl border border-gray-300 bg-slate-50 outline-none hover:ring focus:ring-2 focus:ring-teal-600 transition">
              <option value="Gangguan pernapasan">Gangguan pernapasan</option>
              <option>Gangguan pendengaran</option>
              <option>Musculoskeletal</option>
              <option>Stres kerja</option>
              <option value="lainnya">Lainnya</option>
            </select>
            <input type="text" name="od[0][disease_other]" placeholder="Sebutkan penyakit lainnya"
              class="od-disease-other w-full px-4 py-3 mt-3 rounded-lg border border-gray-300 bg-slate-50 hidden">
          </div>

          <!-- Unit/Departemen terdampak -->
          <div class="w-6/12 max-md:w-full">
            <label class="block pb-2 text-base font-medium">Unit/Departemen terdampak</label>
            <select name="od[0][unit]" class="od-unit w-full px-8 py-4 mt-2 text-base text-black rounded-2xl border border-gray-300 bg-slate-50 outline-none hover:ring focus:ring-2 focus:ring-teal-600 transition">
              <option value="Produksi">Produksi</option>
              <option>Produksi</option>
              <option>Gudang</option>
              <option>Kantor</option>
              <option value="lainnya">Lainnya</option>
            </select>
            <input type="text" name="od[0][unit_other]" placeholder="Sebutkan unit/departemen lainnya"
              class="od-unit-other w-full px-4 py-3 mt-3 rounded-lg border border-gray-300 bg-slate-50 hidden">
          </div>
        </div>

        <div class="w-full mt-6">
  <label class="block pb-2 text-base font-medium">Tindakan pencegahan atau program kesehatan yang dilakukan</label>
  <textarea name="od[0][actions]" rows="5"
    class="od-actions w-full px-8 py-4 text-base text-black rounded-2xl border border-gray-300 bg-slate-50 placeholder-black/50 outline-none hover:ring focus:ring-2 focus:ring-teal-600 transition resize-y">Pemberian program kesehatan, pelatihan, APD, dan pemeriksaan berkala.</textarea>
</div>
        <div class="mt-4 flex justify-end">
            <button type="button" class="od-remove hidden px-4 py-2 text-sm rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
                Hapus
            </button>
        </div>
    </div>
</template>
<script>
    // Helper untuk menampilkan/menyembunyikan elemen
    function toggleEl(el, show, disable = true) {
        if (!el) return;
        el.classList.toggle('hidden', !show);
        if (disable) el.disabled = !show;
    }

    document.addEventListener('DOMContentLoaded', function () {
        // ====== Elemen Utama ======
        const odReport = document.getElementById('od_report');
        const odDetails = document.getElementById('od_details');
        const listContainer = document.getElementById('od_list');
        const addButton = document.getElementById('od_add_item');
        const itemTemplate = document.getElementById('od_item_tpl');

        // ====== Fungsi untuk Toggle Detail Ya/Tidak ======
        function syncOdReportVisibility() {
            const showDetails = odReport && odReport.value === 'ya';
            toggleEl(odDetails, showDetails, false);

            if (odDetails) {
                odDetails.querySelectorAll('input, select, textarea').forEach(el => {
                    el.disabled = !showDetails;
                });
            }
            
            // Jika "Ya" dipilih dan belum ada item, tambahkan satu
            const items = listContainer.querySelectorAll('.od-item');
            if (showDetails && items.length === 0) {
                addNewItem();
            }
        }

        if (odReport) {
            odReport.addEventListener('change', syncOdReportVisibility);
            syncOdReportVisibility(); // Jalankan saat halaman dimuat
        }
        
        // Cek jika elemen-elemen penting tidak ada
        if (!listContainer || !addButton || !itemTemplate) {
            console.error('Elemen penting untuk form dinamis tidak ditemukan!');
            return;
        }

        // ====== Fungsi untuk Form Dinamis ======
        
        // Mengatur ulang index `name` pada setiap field
        function reindexItems() {
            const items = listContainer.querySelectorAll('.od-item');
            items.forEach((item, idx) => {
                item.querySelectorAll('input, select, textarea').forEach(el => {
                    // Menggunakan dataset untuk menyimpan nama dasar agar lebih fleksibel
                    const baseName = el.getAttribute('name').split(/\[[0-9]+\]/).pop(); // e.g., [cases], [disease]
                    el.setAttribute('name', `od[${idx}]${baseName}`);
                });

                // Tampilkan tombol hapus hanya jika item lebih dari satu
                const removeBtn = item.querySelector('.od-remove');
                if (removeBtn) {
                    toggleEl(removeBtn, items.length > 1, false);
                }
            });
        }
        
        // Mengaktifkan fungsionalitas untuk opsi "Lainnya"
        function attachOtherHandlers(item) {
            const selects = item.querySelectorAll('select.od-disease, select.od-unit');
            selects.forEach(selectEl => {
                const otherInput = selectEl.nextElementSibling;
                if (otherInput && otherInput.tagName === 'INPUT') {
                    const sync = () => {
                        const isOther = selectEl.value === 'lainnya';
                        toggleEl(otherInput, isOther);
                        if (!isOther) otherInput.value = '';
                    };
                    selectEl.addEventListener('change', sync);
                    sync(); // Panggil saat pertama kali
                }
            });
        }
        
        // Menambahkan fungsi hapus ke tombol
        function attachRemoveHandler(item) {
            const removeBtn = item.querySelector('.od-remove');
            if (!removeBtn) return;
            removeBtn.addEventListener('click', () => {
                item.remove();
                reindexItems();
            });
        }

        // Fungsi utama untuk menambah item baru
        function addNewItem() {
            const clone = itemTemplate.content.firstElementChild.cloneNode(true);
            attachOtherHandlers(clone);
            attachRemoveHandler(clone);
            listContainer.appendChild(clone);
            reindexItems();
        }

        // Event listener untuk tombol "Tambah"
        addButton.addEventListener('click', addNewItem);

    });
</script>